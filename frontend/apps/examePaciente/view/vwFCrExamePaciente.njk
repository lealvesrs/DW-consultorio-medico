{% extends "templates/base.html" %}

{% block content %}
<div x-data="examePacienteForm()">
  <ol class="breadcrumb mb-3">
    <li class="breadcrumb-item active">{{ title }}</li>
  </ol>

  <div class="row justify-content-center">
    <div class="col-md-6">
    <div class="card-body">
      <form>

     <div class="row">
        <div class="col-12">
          <label for="paciente_id" class="form-label fw-semibold">Paciente</label>
          <select class="form-select" id="paciente_id" x-model="form.paciente_id" required>
            <option value="">Selecione...</option>
            {% for pac in paciente %}
              <option value="{{pac.paciente_id}}">{{pac.nome}}</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-8">
          <div class="form-group">
            <label for="exame_id">Exames</label>
            <select class="form-select" id="exame_id" x-model="form.exame_id" required>
            <option value="">Selecione...</option>
              {% for ex in exame %}
                <option value="{{ex.exame_id}}">{{ex.nome}}</option>
              {% endfor %}
            </select>
          </div>
        </div>
      
          <div class="col-4">
            <div class="form-group">
              <label for="data_exame">Data do Exame</label>
              <input type="datetime-local" class="form-control" id="data_exame" x-model="form.data_exame" :disabled="disabled">
            </div>
          </div>
        </div>


      <div class="col-12">
          <div class="form-group">
            <label for="laudo">Laudo</label>
            <textarea rows="5" class="form-control" id="laudo" x-model="form.laudo" :disabled="disabled"></textarea>
          </div>
        </div>
        

        <div class="col-12 d-flex gap-2 mt-3">
          <button type="button" @click="insertForm()" class="btn btn-brown px-4">Salvar</button>
          <a href="/examePaciente/manutExamePaciente" class="btn btn-info px-4">Retornar</a>
        </div>
      </form>

        <template x-if="message">
          <div class="mt-3" :class="messageClass" x-text="message"></div>
        </template>
      </div>
    </div>
  </div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/locale/pt-br.min.js"></script>

<script>
  window.onload = function () {
    windowOnLoad();
    const localErro = "{{erro}}";
    if (localErro) alert("[vwExamePaciente|onload] Erro do servidor: " + localErro);
    $("#laudo").focus();
  };

  function examePacienteForm() {
    return {
      form: { paciente_id: '', exame_id: '', laudo: '', data_exame: '', removido: false },
      message: '',
      messageClass: '',

      async insertForm() {
        try {
          const response = await fetch('/examePaciente/insertExamePaciente', {
            method: 'POST',
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(this.form)
          });
          const result = await response.json();
          if (result.status === "ok") {
            alert("Exame Realizado cadastrado com sucesso!");
            this.resetForm();
          } else this.showError(result.status);
        } catch (error) { this.showError(error.message); }
      },

      resetForm() {
        this.form = { paciente_id: '',  exame_id: '', laudo: '', valor_total: '', data_exame: '', removido: false };
        this.message = ''; this.messageClass = '';
      },

      showError(msg) {
        this.message = `Erro: ${msg}`;
        this.messageClass = 'alert alert-danger';
      }
    };
  }
</script>
{% endblock %}
